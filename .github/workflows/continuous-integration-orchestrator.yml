name: CI Orchestrator

on:
  workflow_call:
    inputs:
      project-path:
        description: 'Path to the project directory'
        required: false
        type: string
        default: '.'
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.13'
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  detect-language:
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
    steps:
    - uses: actions/checkout@v4

    - name: Detect language
      id: detect
      working-directory: ${{ inputs.project-path }}
      run: |
        LANG=$(grep "^sonar.language=" sonar-project.properties | cut -d'=' -f2)
        echo "language=$LANG" >> $GITHUB_OUTPUT
        echo "üîç Detected language: $LANG"

  python-ci:
    needs: detect-language
    if: needs.detect-language.outputs.language == 'python'
    uses: Traffic-Tech/Traffic.Tech.GitHub.Core.Workflows/.github/workflows/ci-python.yml@master
    with:
      project-path: ${{ inputs.project-path }}
      python-version: ${{ inputs.python-version }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  # TODO: Crear los siguientes CIs cuando se necesiten
  # nodejs-ci:
  #   needs: detect-language
  #   if: needs.detect-language.outputs.language == 'nodejs'
  #   uses: Traffic-Tech/Traffic.Tech.GitHub.Core.Workflows/.github/workflows/ci-nodejs.yml@master
  #   secrets:
  #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # terraform-ci:
  #   needs: detect-language
  #   if: needs.detect-language.outputs.language == 'terraform'
  #   uses: Traffic-Tech/Traffic.Tech.GitHub.Core.Workflows/.github/workflows/ci-terraform.yml@master
  #   secrets:
  #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # kubernetes-ci:
  #   needs: detect-language
  #   if: needs.detect-language.outputs.language == 'kubernetes'
  #   uses: Traffic-Tech/Traffic.Tech.GitHub.Core.Workflows/.github/workflows/ci-kubernetes.yml@master
  #   secrets:
  #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
